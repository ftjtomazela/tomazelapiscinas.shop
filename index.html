<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Motorista Pro - Conchas</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: #121212; color: #fff; height: 100vh; overflow: hidden; }
        
        .hidden { display: none !important; }
        
        .btn { width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; font-size: 1rem; margin-bottom: 10px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-yellow { background: #f1c40f; color: #000; }
        .btn-green { background: #2ecc71; color: #000; }
        .btn-blue { background: #3498db; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        .btn-outline { background: transparent; border: 1px solid #444; color: #888; font-size: 0.8rem; margin-top: 5px; }
        
        #tela-auth, #dashboard, #tela-corrida { height: 100%; display: flex; flex-direction: column; }
        
        #tela-auth { justify-content: center; padding: 30px; background: radial-gradient(circle at top, #2c2c2c, #000); }
        .input-dark { width: 100%; padding: 15px; background: #333; border: 1px solid #444; color: white; border-radius: 10px; margin-bottom: 15px; outline: none; font-size: 1rem; }
        .input-dark:focus { border-color: #f1c40f; }
        
        .header-status { padding: 15px; background: #1e1e1e; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .toggle-btn { background: #333; color: #888; padding: 8px 15px; border-radius: 20px; border: 1px solid #444; font-size: 0.8rem; }
        .toggle-btn.online { background: #2ecc71; color: #000; }
        .btn-sair { background: none; border: 1px solid #e74c3c; color: #e74c3c; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; margin-top: 5px; cursor: pointer; }
        
        .ganhos-card { background: linear-gradient(135deg, #1e1e1e 0%, #252525 100%); margin: 15px; padding: 20px; border-radius: 15px; border: 1px solid #333; text-align: center; }
        .ganhos-valor { font-size: 2.5rem; font-weight: 800; color: #2ecc71; margin: 5px 0; }
        .ganhos-label { color: #888; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        .card-pedido { background: #1e1e1e; padding: 20px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid #f1c40f; }
        
        #tela-corrida { padding: 20px; background: #000; text-align: center; }
        .status-badge { background: #333; color: #f1c40f; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 15px; display: inline-block; }
        .info-box { background: #1e1e1e; padding: 20px; border-radius: 15px; text-align: left; margin-bottom: 20px; }

        .modal-full { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 2000; padding: 20px; overflow-y: auto; display: none; }
        .hist-item { background: #1e1e1e; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #2ecc71; display: flex; justify-content: space-between; align-items: center; }
        .hist-data { font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px; }

        .chat-modal { position: fixed; bottom: 0; left: 0; width: 100%; height: 70%; background: #1e1e1e; z-index: 6000; border-radius: 20px 20px 0 0; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s ease-out; }
        .chat-modal.open { transform: translateY(0); }
        .chat-header { padding: 15px; background: #000; color: white; display: flex; justify-content: space-between; align-items: center; border-radius: 20px 20px 0 0; border-bottom: 1px solid #333; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .chat-footer { padding: 10px; background: #252525; display: flex; align-items: center; gap: 10px; border-top: 1px solid #333; }
        .chat-input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #444; background: #333; color: white; outline: none; }
        .chat-send { background: #f1c40f; border: none; width: 40px; height: 40px; border-radius: 50%; color: #000; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 0.9rem; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: #f1c40f; color: #000; border-radius: 15px 15px 0 15px; }
        .msg-other { align-self: flex-start; background: #333; color: #fff; border-radius: 15px 15px 15px 0; border: 1px solid #444; }
    </style>
</head>
<body>
    <div id="tela-auth">
        <h1 style="text-align:center; color:#f1c40f; margin-bottom:20px;">DRIVER PRO</h1>
        <input type="email" id="email" class="input-dark" placeholder="E-mail">
        <input type="password" id="senha" class="input-dark" placeholder="Senha">
        <button id="btnLogin" class="btn btn-yellow" onclick="login()">ENTRAR</button>
        <p id="msgErro" style="color:#e74c3c; text-align:center; display:none; margin-top:15px; background: rgba(255,0,0,0.1); padding: 10px; border-radius: 5px; font-size: 0.9rem;"></p>
    </div>

    <div id="dashboard" class="hidden">
        <div class="header-status">
            <div>
                <strong id="motoristaNome" onclick="abrirMinhaConta()">Motorista</strong>
                <p id="motoristaNota" style="font-size:0.8rem; color:#f1c40f;">5.0 ‚≠ê</p>
                <button onclick="sair()" class="btn-sair">SAIR DA CONTA</button>
            </div>
            <button id="btnStatus" class="toggle-btn" onclick="toggleStatus()">üî¥ OFFLINE</button>
        </div>
        <div class="ganhos-card">
            <div class="ganhos-label">Ganhos Hoje</div>
            <div class="ganhos-valor" id="ganhosHoje">R$ 0,00</div>
            <button class="btn btn-outline" onclick="abrirHistorico()">Ver Hist√≥rico Completo</button>
        </div>
        <div style="padding:0 20px; flex:1; overflow-y:auto;">
            <h3 style="color:#888; margin-bottom:15px; font-size:0.9rem;">CHAMADAS DISPON√çVEIS</h3>
            <div id="lista-pedidos"><p style="text-align:center; color:#444; margin-top:30px;">Fique Online para receber...</p></div>
        </div>
    </div>

    <div id="tela-corrida" class="hidden">
        <div class="status-badge" id="statusCorridaTexto">BUSCANDO PASSAGEIRO</div>
        <div class="info-box"><small style="color:#888;">Destino Atual:</small><h2 id="destinoAtual" style="color:#fff; margin-top:5px;">...</h2></div>
        <a id="btnGps" href="#" target="_blank" style="text-decoration:none;"><button class="btn btn-blue">üó∫Ô∏è ABRIR GPS</button></a>
        <button class="btn btn-outline" style="border-color:#f1c40f; color:#f1c40f; margin-bottom:10px;" onclick="toggleChat()">üí¨ Falar com Passageiro</button>
        <button id="btnAcaoPrincipal" class="btn btn-yellow" onclick="avancarEtapa()">CHEGUEI NO LOCAL</button>
        <div style="margin-top:auto; margin-bottom:20px;">
            <small style="color:#666;">Passageiro:</small>
            <h3 id="nomePassageiro">...</h3>
            <h2 style="color:#2ecc71; margin-top:5px;">R$ 7,00</h2>
        </div>
    </div>

    <div id="modal-conta" class="modal-full">
        <div class="modal-header"><button class="back-btn" onclick="fecharModal('modal-conta')">‚Üê</button><h2>Perfil</h2></div>
        <div style="text-align:center; margin-bottom:20px;">
            <h1 id="perfilNota" style="color:#f1c40f;">5.0 ‚≠ê</h1>
            <p style="color:#aaa;">Sua avalia√ß√£o m√©dia</p>
        </div>
        <label style="color:#888">Nome</label><input type="text" id="perfilNome" class="input-dark">
        <label style="color:#888">Telefone</label><input type="text" id="perfilTel" class="input-dark">
        <button class="btn btn-yellow" onclick="salvarPerfil()">SALVAR ALTERA√á√ïES</button>
    </div>

    <div id="modal-historico" class="modal-full">
        <div class="modal-header"><button class="back-btn" onclick="fecharModal('modal-historico')">‚Üê</button><h2>Hist√≥rico</h2></div>
        <div id="lista-historico" style="color:#fff;">Carregando...</div>
    </div>

    <div id="avaliacao-modal" class="modal-full" style="display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.9); z-index: 7000;">
        <div style="background:#1e1e1e; padding:30px; border-radius:15px; text-align:center; width:90%; color:white;">
            <h3>Corrida Finalizada!</h3>
            <p style="color:#aaa; margin-bottom:20px;">Avalie o passageiro</p>
            <div style="font-size:40px; margin-bottom:20px; cursor:pointer;">
                <span onclick="setEstrela(1)">‚≠ê</span><span onclick="setEstrela(2)">‚≠ê</span><span onclick="setEstrela(3)">‚≠ê</span><span onclick="setEstrela(4)">‚≠ê</span><span onclick="setEstrela(5)">‚≠ê</span>
            </div>
            <p id="nota-selecionada" style="font-weight:bold; color:#f1c40f;">0 Estrelas</p>
            <button class="btn btn-yellow" onclick="enviarAvaliacao()">ENVIAR AVALIA√á√ÉO</button>
        </div>
    </div>

    <div id="chat-modal" class="chat-modal">
        <div class="chat-header"><span>Conversa com Passageiro</span><button onclick="toggleChat()" style="background:none; border:none; color:white; font-size:20px;">‚úï</button></div>
        <div id="chat-msgs" class="chat-body"></div>
        <div class="chat-footer"><input type="text" id="chatInput" class="chat-input" placeholder="Digite uma mensagem..."><button class="chat-send" onclick="enviarMensagem()">‚û§</button></div>
    </div>

    <audio id="som" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDmtTBGw2ZxtKaUlbD5BlPgwQO26VFyyzU",
            authDomain: "ubermotoconchas.firebaseapp.com",
            projectId: "ubermotoconchas",
            storageBucket: "ubermotoconchas.firebasestorage.app",
            messagingSenderId: "697414710628",
            appId: "1:697414710628:web:597892e4ba169fa4de7671",
            measurementId: "G-3LF6T0KEVF"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let messaging;
        try {
            messaging = firebase.messaging();
        } catch (e) {
            console.log("Messaging n√£o suportado neste navegador");
        }

        let isOnline = false;
        let watchID = null;
        let corridaAtual = null; 
        let etapaAtual = 0; 
        let wakeLock = null;
        let notaAtual = 0;

        window.onbeforeunload = function() {
            if (corridaAtual && corridaAtual.status !== 'finalizado') {
                return "Voc√™ tem uma corrida em andamento. N√£o saia!";
            }
        };

        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                auth.onAuthStateChanged(async u => {
                    if(u) {
                        document.getElementById('tela-auth').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        await carregarPerfil(u.uid);
                        verificarCorridaAtiva(u.uid);
                        atualizarGanhosHoje(u.uid);
                        configurarNotificacoes(u.uid);
                    } else {
                        document.getElementById('tela-auth').classList.remove('hidden');
                        document.getElementById('dashboard').classList.add('hidden');
                    }
                });
            })
            .catch(err => console.error("Erro persistencia:", err));

        // --- SISTEMA DE PERFIL E NOTAS ---
        async function carregarPerfil(uid) {
            const doc = await db.collection('users').doc(uid).get();
            const dados = doc.exists ? doc.data() : {};
            const nota = await calcularNotaMedia(uid);
            
            document.getElementById('motoristaNome').innerText = dados.nome || "Motorista";
            document.getElementById('motoristaNota').innerText = nota + " ‚≠ê";
            document.getElementById('perfilNota').innerText = nota + " ‚≠ê";
            
            document.getElementById('perfilNome').value = dados.nome || "";
            document.getElementById('perfilTel').value = dados.telefone || "";
        }

        async function calcularNotaMedia(uid) {
            const snap = await db.collection('users').doc(uid).collection('avaliacoes').get();
            if(snap.empty) return "Novo (N/A)";
            
            let soma = 0;
            snap.forEach(d => soma += d.data().nota);
            const media = soma / snap.size;
            return media.toFixed(1);
        }

        function salvarPerfil() {
            const nome = document.getElementById('perfilNome').value;
            const tel = document.getElementById('perfilTel').value;
            if(!nome || !tel) return alert("Preencha todos os campos.");
            
            db.collection('users').doc(auth.currentUser.uid).update({
                nome: nome,
                telefone: tel
            }).then(() => {
                alert("Perfil atualizado!");
                document.getElementById('motoristaNome').innerText = nome;
                fecharModal('modal-conta');
            }).catch(err => alert("Erro: " + err.message));
        }

        // --- SISTEMA DE AVALIA√á√ÉO ---
        function abrirAvaliacao() {
            document.getElementById('avaliacao-modal').style.display = 'flex';
        }

        function setEstrela(n) {
            notaAtual = n;
            document.getElementById('nota-selecionada').innerText = n + " Estrelas";
        }

        function enviarAvaliacao() {
            if(notaAtual === 0) return alert("Selecione uma nota!");
            
            if(corridaAtual && corridaAtual.uid) { // uid √© o ID do passageiro
                db.collection('users').doc(corridaAtual.uid).collection('avaliacoes').add({
                    nota: notaAtual,
                    avaliador: auth.currentUser.uid,
                    data: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert("Avalia√ß√£o enviada!");
                    location.reload();
                });
            } else {
                location.reload();
            }
        }

        // --- NOTIFICA√á√ïES (CORRIGIDO) ---
        function configurarNotificacoes(uid) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted' && messaging) {
                    messaging.getToken({ vapidKey: "BN8AZa8hMQBabhaTW-9rNXjLX2-wpBjG-lNpsCl82fuWcjyUtVCvCBJFYUUVmSVD-L0a3OuJWY3fRtaTpo7qGE0" }).then((currentToken) => {
                        if (currentToken) {
                            db.collection('users').doc(uid).update({ fcmToken: currentToken });
                        }
                    }).catch((err) => {
                        console.log('Erro ao pegar token FCM: ', err);
                    });
                }
            });
        }

        function dispararNotificacaoLocal(titulo, corpo) {
            if (Notification.permission === 'granted') {
                new Notification(titulo, {
                    body: corpo,
                    icon: 'https://cdn-icons-png.flaticon.com/512/1986/1986937.png',
                    vibrate: [200, 100, 200]
                });
            }
        }

        // --- LOGIN ---
        function login() {
            const e = document.getElementById('email').value.trim();
            const s = document.getElementById('senha').value.trim();
            const btn = document.getElementById('btnLogin');
            const msg = document.getElementById('msgErro');

            if (!e || !s) { alert("Digite e-mail e senha!"); return; }

            btn.innerText = "Entrando...";
            btn.disabled = true;
            msg.style.display = 'none';

            auth.signInWithEmailAndPassword(e, s)
                .catch(err => {
                    btn.innerText = "ENTRAR";
                    btn.disabled = false;
                    let texto = "Erro: " + err.message;
                    if (err.code === 'auth/invalid-credential') texto = "Senha ou E-mail incorretos.";
                    msg.innerText = texto;
                    msg.style.display = 'block';
                    alert(texto); 
                });
        }

        function sair() {
            if(confirm("Deseja realmente sair da conta?")) {
                if(isOnline) toggleStatus(); 
                auth.signOut().then(() => window.location.reload());
            }
        }

        // --- WAKE LOCK ---
        async function ativarWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {}
        }
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible' && isOnline) await ativarWakeLock();
        });

        // --- STATUS ---
        function toggleStatus() {
            isOnline = !isOnline;
            const btn = document.getElementById('btnStatus');
            if(isOnline) {
                btn.innerText = "üü¢ ONLINE"; btn.classList.add('online');
                monitorarPedidos();
                document.getElementById('som').play().catch(()=>{});
                iniciarGPSGeral();
                ativarWakeLock();
            } else {
                btn.innerText = "üî¥ OFFLINE"; btn.classList.remove('online');
                document.getElementById('lista-pedidos').innerHTML = "";
                if(watchID) navigator.geolocation.clearWatch(watchID);
                if(wakeLock) wakeLock.release().then(() => wakeLock = null);
            }
        }

        function monitorarPedidos() {
            db.collection("corridas").where("status", "==", "pendente").onSnapshot(async snap => {
                if(!isOnline) return;
                const div = document.getElementById('lista-pedidos');
                div.innerHTML = "";
                
                let temNova = false;
                // Usamos for...of para poder usar await na m√©dia de nota
                for (const doc of snap.docs) {
                    const d = doc.data();
                    let notaPass = "Novo";
                    if(d.uid) {
                        notaPass = await calcularNotaMedia(d.uid);
                    }

                    if(d.status === 'pendente') { 
                        temNova = true;
                        div.innerHTML += `
                            <div class="card-pedido">
                                <h3>${d.destino}</h3>
                                <p style="color:#aaa; font-size:0.9rem;">Passageiro: ${d.passageiro || 'Cliente'} (${notaPass} ‚≠ê)</p>
                                <h2 style="color:#2ecc71; margin:10px 0;">${d.valor}</h2>
                                <button class="btn btn-yellow" onclick="aceitarCorrida('${doc.id}')">ACEITAR CORRIDA</button>
                            </div>`;
                    }
                }

                if (temNova) {
                    document.getElementById('som').play().catch(()=>{});
                    dispararNotificacaoLocal("Nova Corrida", "Um passageiro est√° solicitando uma moto.");
                }
            });
        }

        // --- CORRIDA ---
        function aceitarCorrida(id) {
            localStorage.setItem('corridaAtivaID', id);
            
            db.collection("corridas").doc(id).update({ status: "aceito", motoristaId: auth.currentUser.uid })
            .then(() => carregarTelaCorrida(id));
        }

        function carregarTelaCorrida(id) {
            db.collection("corridas").doc(id).get().then(async doc => {
                if (!doc.exists) return;
                corridaAtual = { id: doc.id, ...doc.data() };
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('tela-corrida').classList.remove('hidden');
                
                // Mostra nota do passageiro na tela da corrida
                let notaPass = "Novo";
                if(corridaAtual.uid) {
                    notaPass = await calcularNotaMedia(corridaAtual.uid);
                }
                document.getElementById('nomePassageiro').innerText = `${corridaAtual.passageiro || "Cliente"} (${notaPass} ‚≠ê)`;
                
                if(corridaAtual.status === 'aceito') configurarEtapa(0);
                else if(corridaAtual.status === 'aguardando_passageiro') configurarEtapa(1);
                else if(corridaAtual.status === 'em_viagem') configurarEtapa(2);
                
                monitorarGPSCorrida(id);
                atualizarLinkGPS();
                monitorarChat(id);
            });
        }

        function configurarEtapa(etapa) {
            etapaAtual = etapa;
            const btn = document.getElementById('btnAcaoPrincipal');
            const statusTxt = document.getElementById('statusCorridaTexto');
            const destinoTxt = document.getElementById('destinoAtual');

            if (etapa === 0) {
                statusTxt.innerText = "BUSCANDO PASSAGEIRO";
                destinoTxt.innerText = "Local do Passageiro"; 
                btn.innerText = "üìç CHEGUEI NO LOCAL";
                btn.className = "btn btn-yellow";
            } else if (etapa === 1) {
                statusTxt.innerText = "AGUARDANDO PASSAGEIRO";
                destinoTxt.innerText = "Aguarde o embarque...";
                btn.innerText = "‚ñ∂Ô∏è INICIAR VIAGEM";
                btn.className = "btn btn-green";
                db.collection("corridas").doc(corridaAtual.id).update({ status: "aguardando_passageiro" });
            } else if (etapa === 2) {
                statusTxt.innerText = "EM ROTA AO DESTINO";
                destinoTxt.innerText = corridaAtual.destino;
                btn.innerText = "üèÅ FINALIZAR CORRIDA";
                btn.className = "btn btn-red";
                db.collection("corridas").doc(corridaAtual.id).update({ status: "em_viagem" });
            }
            atualizarLinkGPS();
        }

        function atualizarLinkGPS() {
            const btn = document.getElementById('btnGps');
            let lat, lng;

            if (etapaAtual === 0 && corridaAtual.origem) {
                lat = corridaAtual.origem.lat;
                lng = corridaAtual.origem.lng;
            } else if (etapaAtual === 2 && corridaAtual.destinoCoords) {
                lat = corridaAtual.destinoCoords.lat;
                lng = corridaAtual.destinoCoords.lng;
            }

            if (lat && lng) {
                btn.href = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
                btn.style.opacity = "1";
                btn.style.pointerEvents = "auto";
            } else {
                btn.href = "#";
                btn.style.opacity = "0.5";
                btn.style.pointerEvents = "none";
            }
        }

        function avancarEtapa() {
            if (etapaAtual === 0) { if(confirm("Voc√™ chegou no local?")) configurarEtapa(1); }
            else if (etapaAtual === 1) { if(confirm("Passageiro subiu? Iniciar?")) configurarEtapa(2); }
            else if (etapaAtual === 2) { if(confirm("Finalizar corrida?")) finalizarCorrida(); }
        }

        function finalizarCorrida() {
            localStorage.removeItem('corridaAtivaID');
            const idFinal = corridaAtual ? corridaAtual.id : null;
            if(idFinal) {
                 db.collection("corridas").doc(idFinal).update({ status: "finalizado" })
                 .then(() => {
                     alert("Finalizada! R$ 7,00");
                     atualizarGanhosHoje(auth.currentUser.uid);
                     abrirAvaliacao(); // <--- ABRE AVALIA√á√ÉO
                 });
            } else {
                location.reload();
            }
        }

        // --- CHAT ---
        function toggleChat() {
            document.getElementById('chat-modal').classList.toggle('open');
        }

        function enviarMensagem() {
            const input = document.getElementById('chatInput');
            const texto = input.value.trim();
            if(!texto || !corridaAtual) return;

            db.collection('corridas').doc(corridaAtual.id).collection('mensagens').add({
                texto: texto,
                remetente: 'motorista',
                data: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = "";
        }

        function monitorarChat(id) {
            db.collection('corridas').doc(id).collection('mensagens')
                .orderBy('data', 'asc')
                .onSnapshot(snap => {
                    const div = document.getElementById('chat-msgs');
                    div.innerHTML = "";
                    snap.forEach(doc => {
                        const msg = doc.data();
                        const classe = msg.remetente === 'motorista' ? 'msg-me' : 'msg-other';
                        div.innerHTML += `<div class="msg ${classe}">${msg.texto}</div>`;
                    });
                    div.scrollTop = div.scrollHeight;
                });
        }

        // --- GPS E DADOS ---
        function iniciarGPSGeral() {
            if(navigator.geolocation) watchID = navigator.geolocation.watchPosition(pos => { }, null, { enableHighAccuracy: true });
        }

        function monitorarGPSCorrida(idCorrida) {
            if(navigator.geolocation) {
                if(watchID) navigator.geolocation.clearWatch(watchID);
                watchID = navigator.geolocation.watchPosition(pos => {
                    const vel = pos.coords.speed || 0;
                    db.collection("corridas").doc(idCorrida).update({
                        motoristaLat: pos.coords.latitude, motoristaLng: pos.coords.longitude, motoristaSpeed: vel
                    });
                }, null, { enableHighAccuracy: true });
            }
        }

        async function atualizarGanhosHoje(uid) {
            const hoje = new Date();
            hoje.setHours(0,0,0,0);
            
            const snap = await db.collection('corridas')
                .where('motoristaId', '==', uid)
                .where('status', '==', 'finalizado')
                .limit(50)
                .get();

            let total = 0;
            snap.forEach(doc => {
                const d = doc.data();
                if (d.data && d.data.toDate() >= hoje) {
                    const val = parseFloat(d.valor.replace('R$','').replace(',','.').trim());
                    if(!isNaN(val)) total += val;
                }
            });
            
            document.getElementById('ganhosHoje').innerText = `R$ ${total.toFixed(2).replace('.',',')}`;
        }

        async function abrirHistorico() {
            const uid = auth.currentUser.uid;
            document.getElementById('modal-historico').style.display = 'block';
            const div = document.getElementById('lista-historico');
            
            const snap = await db.collection('corridas')
                .where('motoristaId', '==', uid)
                .where('status', '==', 'finalizado')
                .limit(20)
                .get();

            div.innerHTML = "";
            if(snap.empty) {
                div.innerHTML = "<p style='color:#666; text-align:center;'>Nenhuma corrida recente.</p>";
                return;
            }

            snap.forEach(doc => {
                const d = doc.data();
                const dataFormatada = d.data ? d.data.toDate().toLocaleDateString('pt-BR') : 'Data desc.';
                div.innerHTML += `
                    <div class="hist-item">
                        <div>
                            <span class="hist-data">${dataFormatada}</span>
                            <strong style="color:white;">${d.destino}</strong>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:#2ecc71; font-weight:bold;">${d.valor}</div>
                            <small style="color:#666;">Finalizado</small>
                        </div>
                    </div>
                `;
            });
        }

        function abrirMinhaConta() { document.getElementById('modal-conta').style.display = 'block'; }
        function fecharModal(id) { document.getElementById(id).style.display = 'none'; }

        function verificarCorridaAtiva(uid) {
            const idSalvo = localStorage.getItem('corridaAtivaID');
            if (idSalvo) {
                carregarTelaCorrida(idSalvo);
            } else {
                db.collection('corridas').where('motoristaId', '==', uid).get().then(snap => {
                    snap.forEach(doc => {
                        const d = doc.data();
                        if(['aceito', 'aguardando_passageiro', 'em_viagem'].includes(d.status)) {
                            localStorage.setItem('corridaAtivaID', doc.id);
                            carregarTelaCorrida(doc.id);
                        }
                    });
                });
            }
        }
    </script>
</body>
</html>
