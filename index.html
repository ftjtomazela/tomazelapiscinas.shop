<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Motorista Pro - Conchas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: #121212; color: #fff; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; font-size: 1rem; margin-bottom: 10px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-yellow { background: #f1c40f; color: #000; }
        .btn-green { background: #2ecc71; color: #000; }
        .btn-blue { background: #3498db; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        
        #tela-auth, #dashboard, #tela-corrida { height: 100%; display: flex; flex-direction: column; }
        #tela-auth { justify-content: center; padding: 30px; background: radial-gradient(circle at top, #2c2c2c, #000); }
        .input-dark { width: 100%; padding: 15px; background: #333; border: 1px solid #444; color: white; border-radius: 10px; margin-bottom: 15px; outline: none; font-size: 1rem; }
        .input-dark:focus { border-color: #f1c40f; }
        
        .header-status { padding: 20px; background: #1e1e1e; display: flex; justify-content: space-between; align-items: center; }
        .toggle-btn { background: #333; color: #888; padding: 8px 15px; border-radius: 20px; border: 1px solid #444; }
        .toggle-btn.online { background: #2ecc71; color: #000; }
        .card-pedido { background: #1e1e1e; padding: 20px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid #f1c40f; }
        
        #tela-corrida { padding: 20px; background: #000; text-align: center; }
        .status-badge { background: #333; color: #f1c40f; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 15px; display: inline-block; }
        .info-box { background: #1e1e1e; padding: 20px; border-radius: 15px; text-align: left; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="tela-auth">
        <h1 style="text-align:center; color:#f1c40f; margin-bottom:20px;">DRIVER PRO</h1>
        <input type="email" id="email" class="input-dark" placeholder="E-mail">
        <input type="password" id="senha" class="input-dark" placeholder="Senha">
        
        <button id="btnLogin" class="btn btn-yellow" onclick="login()">ENTRAR</button>
        
        <p id="msgErro" style="color:#e74c3c; text-align:center; display:none; margin-top:15px; background: rgba(255,0,0,0.1); padding: 10px; border-radius: 5px;"></p>
        <p style="text-align:center; font-size:0.8rem; color:#666; margin-top:20px;">Abra no Chrome/Safari (N√£o use navegador do WhatsApp)</p>
    </div>

    <div id="dashboard" class="hidden">
        <div class="header-status">
            <div><strong id="motoristaNome">Motorista</strong><div style="font-size:0.8rem; color:#666;">Conchas - SP</div></div>
            <button id="btnStatus" class="toggle-btn" onclick="toggleStatus()">üî¥ OFFLINE</button>
        </div>
        <div style="padding:20px;">
            <h3 style="color:#888; margin-bottom:10px;">Chamadas</h3>
            <div id="lista-pedidos">
                <p style="text-align:center; color:#444; margin-top:30px;">Fique Online para receber...</p>
            </div>
        </div>
    </div>

    <div id="tela-corrida" class="hidden">
        <div class="status-badge" id="statusCorridaTexto">BUSCANDO PASSAGEIRO</div>
        <div class="info-box">
            <small style="color:#888;">Destino Atual:</small>
            <h2 id="destinoAtual" style="color:#fff; margin-top:5px;">...</h2>
        </div>
        <a id="btnGps" href="#" target="_blank" style="text-decoration:none;">
            <button class="btn btn-blue">üó∫Ô∏è ABRIR GPS</button>
        </a>
        <button id="btnAcaoPrincipal" class="btn btn-yellow" onclick="avancarEtapa()">CHEGUEI NO LOCAL</button>
        <div style="margin-top:auto; margin-bottom:20px;">
            <small style="color:#666;">Passageiro:</small>
            <h3 id="nomePassageiro">...</h3>
            <h2 style="color:#2ecc71; margin-top:5px;">R$ 7,00</h2>
        </div>
    </div>

    <audio id="som" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const auth = firebase.auth();
        // db j√° vem do config
        
        let isOnline = false;
        let watchID = null;
        let corridaAtual = null; 
        let etapaAtual = 0; 
        let wakeLock = null;

        // Configura persist√™ncia para manter logado no celular
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                // Monitora estado do login
                auth.onAuthStateChanged(u => {
                    if(u) {
                        document.getElementById('tela-auth').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        document.getElementById('motoristaNome').innerText = u.email.split('@')[0];
                        verificarCorridaAtiva(u.uid); 
                    }
                });
            })
            .catch(err => console.error("Erro persistencia:", err));

        // --- LOGIN COM DEBUG ---
        function login() {
            const e = document.getElementById('email').value.trim();
            const s = document.getElementById('senha').value.trim();
            const btn = document.getElementById('btnLogin');
            const msg = document.getElementById('msgErro');

            if (!e || !s) { alert("Digite e-mail e senha!"); return; }

            btn.innerText = "Entrando...";
            btn.disabled = true;
            msg.style.display = 'none';

            auth.signInWithEmailAndPassword(e, s)
                .then(() => {
                    btn.innerText = "Sucesso!";
                    // O onAuthStateChanged vai fazer a troca de tela
                })
                .catch(err => {
                    // ERRO: Destrava o bot√£o e mostra alerta
                    btn.innerText = "ENTRAR";
                    btn.disabled = false;
                    
                    let textoErro = "Erro desconhecido: " + err.message;
                    if (err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password') textoErro = "Senha ou E-mail incorretos.";
                    if (err.code === 'auth/user-not-found') textoErro = "Usu√°rio n√£o encontrado. Crie a conta no Painel.";
                    if (err.code === 'auth/network-request-failed') textoErro = "Erro de conex√£o. Verifique sua internet.";
                    
                    msg.innerText = textoErro;
                    msg.style.display = 'block';
                    alert(textoErro); // Alerta para mobile
                });
        }

        // --- WAKE LOCK ---
        async function ativarWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => console.log('Tela solta'));
                }
            } catch (err) {}
        }
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible' && isOnline) await ativarWakeLock();
        });

        // --- STATUS ---
        function toggleStatus() {
            isOnline = !isOnline;
            const btn = document.getElementById('btnStatus');
            if(isOnline) {
                btn.innerText = "üü¢ ONLINE"; btn.classList.add('online');
                monitorarPedidos();
                document.getElementById('som').play().catch(()=>{});
                iniciarGPSGeral();
                ativarWakeLock();
            } else {
                btn.innerText = "üî¥ OFFLINE"; btn.classList.remove('online');
                document.getElementById('lista-pedidos').innerHTML = "";
                if(watchID) navigator.geolocation.clearWatch(watchID);
                if(wakeLock) wakeLock.release().then(() => wakeLock = null);
            }
        }

        function monitorarPedidos() {
            db.collection("corridas").where("status", "==", "pendente").onSnapshot(snap => {
                if(!isOnline) return;
                const div = document.getElementById('lista-pedidos');
                div.innerHTML = "";
                if(snap.empty) div.innerHTML = "<p style='color:#666; text-align:center'>Procurando...</p>";
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.status === 'pendente') { 
                        document.getElementById('som').play().catch(()=>{});
                        div.innerHTML += `
                            <div class="card-pedido">
                                <h3>${d.destino}</h3>
                                <p style="color:#aaa; font-size:0.9rem;">Passageiro: ${d.passageiro || 'Cliente'}</p>
                                <h2 style="color:#2ecc71; margin:10px 0;">${d.valor}</h2>
                                <button class="btn btn-yellow" onclick="aceitarCorrida('${doc.id}')">ACEITAR CORRIDA</button>
                            </div>`;
                    }
                });
            });
        }

        function aceitarCorrida(id) {
            db.collection("corridas").doc(id).update({ status: "aceito", motoristaId: auth.currentUser.uid })
            .then(() => carregarTelaCorrida(id));
        }

        function carregarTelaCorrida(id) {
            db.collection("corridas").doc(id).get().then(doc => {
                corridaAtual = { id: doc.id, ...doc.data() };
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('tela-corrida').classList.remove('hidden');
                document.getElementById('nomePassageiro').innerText = corridaAtual.passageiro || "Cliente";
                configurarEtapa(0);
                monitorarGPSCorrida(id);
            });
        }

        function configurarEtapa(etapa) {
            etapaAtual = etapa;
            const btn = document.getElementById('btnAcaoPrincipal');
            const statusTxt = document.getElementById('statusCorridaTexto');
            const destinoTxt = document.getElementById('destinoAtual');
            const btnGps = document.getElementById('btnGps');

            if (etapa === 0) {
                statusTxt.innerText = "BUSCANDO PASSAGEIRO";
                destinoTxt.innerText = "Local do Passageiro"; 
                btn.innerText = "üìç CHEGUEI NO LOCAL";
                btn.className = "btn btn-yellow";
                if(corridaAtual.origem) {
                    const lat = corridaAtual.origem.lat; const lng = corridaAtual.origem.lng;
                    btnGps.href = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
                }
            } else if (etapa === 1) {
                statusTxt.innerText = "AGUARDANDO PASSAGEIRO";
                destinoTxt.innerText = "Aguarde o embarque...";
                btn.innerText = "‚ñ∂Ô∏è INICIAR VIAGEM";
                btn.className = "btn btn-green";
                db.collection("corridas").doc(corridaAtual.id).update({ status: "aguardando_passageiro" });
            } else if (etapa === 2) {
                statusTxt.innerText = "EM ROTA AO DESTINO";
                destinoTxt.innerText = corridaAtual.destino;
                btn.innerText = "üèÅ FINALIZAR CORRIDA";
                btn.className = "btn btn-red";
                if(corridaAtual.destinoCoords) {
                    const lat = corridaAtual.destinoCoords.lat; const lng = corridaAtual.destinoCoords.lng;
                    btnGps.href = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
                }
                db.collection("corridas").doc(corridaAtual.id).update({ status: "em_viagem" });
            }
        }

        function avancarEtapa() {
            if (etapaAtual === 0) { if(confirm("Voc√™ chegou no local?")) configurarEtapa(1); }
            else if (etapaAtual === 1) { if(confirm("Passageiro subiu? Iniciar?")) configurarEtapa(2); }
            else if (etapaAtual === 2) { if(confirm("Finalizar corrida?")) finalizarCorrida(); }
        }

        function finalizarCorrida() {
            db.collection("corridas").doc(corridaAtual.id).update({ status: "finalizado" });
            alert("Finalizada! R$ 7,00");
            location.reload(); 
        }

        function iniciarGPSGeral() {
            if(navigator.geolocation) watchID = navigator.geolocation.watchPosition(pos => { }, null, { enableHighAccuracy: true });
        }

        function monitorarGPSCorrida(idCorrida) {
            if(navigator.geolocation) {
                if(watchID) navigator.geolocation.clearWatch(watchID);
                watchID = navigator.geolocation.watchPosition(pos => {
                    const vel = pos.coords.speed || 0;
                    db.collection("corridas").doc(idCorrida).update({
                        motoristaLat: pos.coords.latitude, motoristaLng: pos.coords.longitude, motoristaSpeed: vel
                    });
                }, null, { enableHighAccuracy: true });
            }
        }

        function verificarCorridaAtiva(uid) {
            db.collection('corridas').where('motoristaId', '==', uid).get().then(snap => {
                snap.forEach(doc => {
                    const d = doc.data();
                    if(['aceito', 'aguardando_passageiro', 'em_viagem'].includes(d.status)) {
                        corridaAtual = { id: doc.id, ...d };
                        document.getElementById('dashboard').classList.add('hidden');
                        document.getElementById('tela-corrida').classList.remove('hidden');
                        monitorarGPSCorrida(corridaAtual.id);
                        if(d.status === 'aceito') configurarEtapa(0);
                        if(d.status === 'aguardando_passageiro') configurarEtapa(1);
                        if(d.status === 'em_viagem') configurarEtapa(2);
                    }
                });
            });
        }
    </script>
</body>
</html>
